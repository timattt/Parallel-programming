# Lock-free стек

Предположим, что мы реализовали наивную реализацию lock-free стека.
При работе с многими потоками нас будут приследовать различные проблемы, такие как UB, ABA, SEGFAULT, ну и то, что оно далеко не всегда будет lock free.

## Hazard pointers

Чтобы не удалить память, которую может держать кто-то другой - нужно на указателе хранить число ссылок на него. В данном случае, все проще, мы можем
просто завести для каждого потока переменную текущего указателя. Теперь любой поток перед удалением должен будет проверить этот массив - не держит ли указатель
кто-то другой. И при необходимости подождать.   
   
Это может быть достаточно долго - в качестве оптимизации можно удалять порциями.

## Счетчик с головой стека

Чтобы избежать ABA мы можем вместе с головой стека хранить число и увеличивать его на 1 с каждой операцией.
Для этого нам нужен CAS на 16 байт. Это можно сделать с помощью asm инструкции.

## Используем атомарные переменные из стандарта

Все любое можно сделать атомарным.

## Оценка производительности

Рассмотрим два варианта - когда push и pop - равномерны и когда неравномерны - то есть идут большими порциями.

![image](https://user-images.githubusercontent.com/25401699/205315658-9957e2b5-8d24-4c35-8395-604ba3efd9c9.png)

